<template x-teleport="body">
  <aside
    class="fixed inset-0 w-full h-screen z-50"
    x-cloak
    x-show="showSearchModal"
    x-data="searchModal"
  >
    {%- comment -%}
      ANCHOR: Overlay
    {%- endcomment -%}
    <div
      class="absolute inset-0 w-full h-full bg-neutral bg-opacity-20"
      @click="showSearchModal = false"
    ></div>

    {%- comment -%}
      ANCHOR: Main Content
    {%- endcomment -%}
    <div class="relative container flex justify-center items-center h-full pointer-events-none">
      <div class="relative w-full md:w-3/4 lg:w-4/6 xl:w-1/2 h-[90%] bg-base-100 z-10 shadow-md rounded-sm border-2 border-primary flex flex-col gap-4 p-2 md:p-4 pointer-events-auto">
        {%- comment -%}
          ANCHOR: Close Button
        {%- endcomment -%}
        <button
          class="absolute -top-1.5 -right-1.5 btn btn-ghost btn-circle btn-sm opacity-50 hover:opacity-100"
          @click="showSearchModal = false"
        >
          {% render 'icon',
            type: 'x'
          %}
        </button>

        {%- comment -%}
          ANCHOR: Search Box
        {%- endcomment -%}
        <input
          class="input input-bordered input-primary input-md md:input-lg w-full"
          type="text"
          placeholder="Search Product"
          @input.debounce.750="(e) => searchProduct(e.target.value)"
        />

        {%- comment -%}
          ANCHOR: Loading
        {%- endcomment -%}
        <template x-if="loading">
          <h1 class="text-center font-light text-2xl md:text-3xl">
            Loading Products...
          </h1>
        </template>


        {%- comment -%}
          ANCHOR: No Results
        {%- endcomment -%}
        <template x-if="!loading && searchResults.length === 0">
          <div class="text-center font-light">
            <h1 class="text-2xl md:text-3xl">
              Sorry No Products Could Be Found
            </h1>
  
            <h3 class="text-xl md:text-2xl mt-2">
              try searching something else
            </h3>
          </div>
        </template>


        {%- comment -%}
          ANCHOR: Search Result Items
        {%- endcomment -%}
        <template x-if="!loading && searchResults.length > 0">
          <div class="flex flex-col gap-2 flex-1 overflow-y-auto">
            <template x-for="product in searchResults">
              <a
                class="w-full flex-shrink-0 h-24 border-2 border-dashed border-primary p-2 flex gap-2"
                :href="product.url"
              >
                <img
                  class="h-full aspect-square object-cover object-center border-2 border-primary"
                  draggable="false"
                  :src="product.featured_image.url"
                />
    
                <div class="flex-1 flex flex-col justify-center gap-1 overflow-hidden pb-1 text-left h-full">
                  <h1
                    class="text-xl sm:text-2xl font-bold uppercase truncate w-full"
                    x-text="product.title"
                  >
                  </h1>
    
                  <div
                    class="text-lg sm:text-xl font-semibold uppercase w-full truncate"
                  >
                    <template x-for="tag in product.tags">
                      <div
                        class="badge badge-sm md:badge-md mr-2"
                        x-text="tag"  
                      >
                      </div>
                    </template>
                  </div>
                </div>
              </a>
            </template>
          </div>
        </template>
      </div>
    </div>
  </aside>
</template>

<script class="hidden">
  document.addEventListener("alpine:init", () => {
    Alpine.data("searchModal", () => ({
      searchResults: [],
      loading: false,
      async searchProduct(search) {
        if (!search) {
          this.searchResults = []
          return
        }

        this.loading = true

        const searchQuery = `?q=${search}&resources[type]=product&resources[options][unavailable_products]=hide`
        const response = await fetch(window.Shopify.routes.root + `search/suggest.json${searchQuery}`)
        const data = await response.json()

        this.loading = false

        this.searchResults = data.resources.results.products
      }
    }))
  })
</script>

